REM ********************************************
REM
REM             Script for Level 218
REM
REM ********************************************

LEVEL_VERSION(1)

SET_GENERATE_SPEED(240)

MAX_CREATURES(ALL_PLAYERS, 20)

START_MONEY(ALL_PLAYERS, 10000)

ADD_CREATURE_TO_POOL(BILE_DEMON,20)
ADD_CREATURE_TO_POOL(DARK_MISTRESS,20)
ADD_CREATURE_TO_POOL(SALAMANDER,20)
ADD_CREATURE_TO_POOL(SORCEROR,20)
ADD_CREATURE_TO_POOL(TROLL,20)
ADD_CREATURE_TO_POOL(GOBLIN,20)
ADD_CREATURE_TO_POOL(FIREFLY,20)
ADD_CREATURE_TO_POOL(DARK_KNIGHT,20)
ADD_CREATURE_TO_POOL(DARK_ELF,20)

CREATURE_AVAILABLE(ALL_PLAYERS, TROLL, 1, 0)
CREATURE_AVAILABLE(ALL_PLAYERS, GOBLIN, 1, 0)
CREATURE_AVAILABLE(ALL_PLAYERS, FIREFLY, 1, 0)
CREATURE_AVAILABLE(ALL_PLAYERS, DARK_MISTRESS, 1, 0)
CREATURE_AVAILABLE(ALL_PLAYERS, SORCEROR, 1, 0)
CREATURE_AVAILABLE(ALL_PLAYERS, BILE_DEMON, 1, 0)
CREATURE_AVAILABLE(ALL_PLAYERS, SALAMANDER, 1, 0)
CREATURE_AVAILABLE(ALL_PLAYERS, DARK_KNIGHT, 1, 0)
CREATURE_AVAILABLE(ALL_PLAYERS, DARK_ELF,1,0)


ROOM_AVAILABLE(ALL_PLAYERS, GUARD_POST, 1, 1)
ROOM_AVAILABLE(ALL_PLAYERS, TREASURE, 1, 1)
ROOM_AVAILABLE(ALL_PLAYERS, RESEARCH, 1, 1)
ROOM_AVAILABLE(ALL_PLAYERS, WORKSHOP, 1, 1)
ROOM_AVAILABLE(ALL_PLAYERS, GARDEN, 1, 1)
ROOM_AVAILABLE(ALL_PLAYERS, LAIR, 1, 1)
ROOM_AVAILABLE(ALL_PLAYERS, GRAVEYARD, 1, 1)
ROOM_AVAILABLE(ALL_PLAYERS, PRISON, 1, 1)
ROOM_AVAILABLE(ALL_PLAYERS, TORTURE, 1, 1)
ROOM_AVAILABLE(ALL_PLAYERS, TRAINING, 1, 1)
ROOM_AVAILABLE(ALL_PLAYERS, BARRACKS, 1, 1)
ROOM_AVAILABLE(ALL_PLAYERS, TEMPLE, 1, 1)
ROOM_AVAILABLE(ALL_PLAYERS, BRIDGE, 1, 1)

MAGIC_AVAILABLE(ALL_PLAYERS, POWER_HAND, 1, 1)
MAGIC_AVAILABLE(ALL_PLAYERS, POWER_OBEY, 1, 1)
MAGIC_AVAILABLE(ALL_PLAYERS, POWER_IMP, 1, 1)
MAGIC_AVAILABLE(ALL_PLAYERS, POWER_SLAP, 1, 1)
MAGIC_AVAILABLE(ALL_PLAYERS, POWER_SIGHT, 1, 0)
MAGIC_AVAILABLE(ALL_PLAYERS, POWER_CALL_TO_ARMS, 1, 0)
MAGIC_AVAILABLE(ALL_PLAYERS, POWER_CAVE_IN, 1, 0)
MAGIC_AVAILABLE(ALL_PLAYERS, POWER_HEAL_CREATURE, 1, 0)
MAGIC_AVAILABLE(ALL_PLAYERS, POWER_HOLD_AUDIENCE, 1, 0)
MAGIC_AVAILABLE(ALL_PLAYERS, POWER_CHICKEN, 1, 0)
MAGIC_AVAILABLE(ALL_PLAYERS, POWER_SPEED, 1, 0)
MAGIC_AVAILABLE(ALL_PLAYERS, POWER_LIGHTNING, 1, 0)
MAGIC_AVAILABLE(ALL_PLAYERS, POWER_CONCEAL, 1, 0)
MAGIC_AVAILABLE(ALL_PLAYERS, POWER_PROTECT, 1, 0)
MAGIC_AVAILABLE(ALL_PLAYERS, POWER_DISEASE, 1, 0)
MAGIC_AVAILABLE(ALL_PLAYERS, POWER_DESTROY_WALLS, 1, 0)
MAGIC_AVAILABLE(ALL_PLAYERS, POWER_ARMAGEDDON, 1, 0)

DOOR_AVAILABLE(ALL_PLAYERS, WOOD, 1, 0)
TRAP_AVAILABLE(ALL_PLAYERS, ALARM, 1, 0)
DOOR_AVAILABLE(ALL_PLAYERS, BRACED, 1, 0)
TRAP_AVAILABLE(ALL_PLAYERS, POISON_GAS, 1, 0)
TRAP_AVAILABLE(ALL_PLAYERS, LAVA, 1, 0)
DOOR_AVAILABLE(ALL_PLAYERS, STEEL, 1, 0)
TRAP_AVAILABLE(ALL_PLAYERS, BOULDER, 1, 0)
DOOR_AVAILABLE(ALL_PLAYERS, MAGIC, 1, 0)
TRAP_AVAILABLE(ALL_PLAYERS, LIGHTNING, 1, 0)
TRAP_AVAILABLE(ALL_PLAYERS, WORD_OF_POWER, 1, 0)

SET_GAME_RULE(ImpWorkExperience,124)

CONCEAL_MAP_RECT(Player0, 120, 120, 240, 240,1)

SET_GAME_RULE(MaxThingsInHand,60)

SET_FLAG(PLAYER_GOOD, FLAG0, 0)

DISPLAY_OBJECTIVE(117, PLAYER0)

CREATE_PARTY(PRINCE1)
ADD_TO_PARTY(PRINCE1, KNIGHT, 10, 30, DEFEND_ROOMS, 0)
ADD_TO_PARTY(PRINCE1, GIANT, 7, 30, DEFEND_PARTY, 0)
ADD_TO_PARTY(PRINCE1, GIANT, 7, 30, DEFEND_PARTY, 0)

CREATE_PARTY(PRINCE2)
ADD_TO_PARTY(PRINCE2, KNIGHT, 10, 30, DEFEND_ROOMS, 0)
ADD_TO_PARTY(PRINCE2, GIANT, 8, 30, DEFEND_PARTY, 0)
ADD_TO_PARTY(PRINCE2, SAMURAI, 7, 30, DEFEND_PARTY, 0)
ADD_TO_PARTY(PRINCE2, SAMURAI, 7, 30, DEFEND_PARTY, 0)
ADD_TO_PARTY(PRINCE2, ARCHER, 8, 30, DEFEND_PARTY, 0)

CREATE_PARTY(PRINCE3)
ADD_TO_PARTY(PRINCE3, KNIGHT, 10, 30, DEFEND_ROOMS, 0)
ADD_TO_PARTY(PRINCE3, FAIRY, 8, 30, DEFEND_PARTY, 0)
ADD_TO_PARTY(PRINCE3, FAIRY, 8, 30, DEFEND_PARTY, 0)
ADD_TO_PARTY(PRINCE3, FAIRY, 7, 30, DEFEND_PARTY, 0)
ADD_TO_PARTY(PRINCE3, SAMURAI, 7, 30, DEFEND_PARTY, 0)
ADD_TO_PARTY(PRINCE3, ARCHER, 9, 30, DEFEND_PARTY, 0)

SET_GAME_RULE(TrainingRoomMaxLevel,4)

IF(PLAYER0, BARRACKS >= 8)
	SET_GAME_RULE(TrainingRoomMaxLevel,5)
ENDIF

IF(PLAYER0, BARRACKS >= 17)
	SET_GAME_RULE(TrainingRoomMaxLevel,6)
ENDIF

IF(PLAYER0, BARRACKS >= 26)
	SET_GAME_RULE(TrainingRoomMaxLevel,7)
ENDIF

IF(PLAYER0, BARRACKS >= 35)
	SET_GAME_RULE(TrainingRoomMaxLevel,8)
ENDIF


if(player0,ENTRANCE == 9)
  next_command_reusable
  max_creatures(Player0,15)
ENDIF
if(player0,ENTRANCE == 18)
  next_command_reusable
  max_creatures(Player0,20)
ENDIF
if(player0,ENTRANCE == 27)
  next_command_reusable
  max_creatures(Player0,25)
ENDIF




REM timer for prince 1 enter
SET_TIMER(PLAYER0, TIMER0)
IF(PLAYER0, TIMER0 >= 1450)
	ADD_PARTY_TO_LEVEL(PLAYER_GOOD, PRINCE1, -1,1)
	ADD_PARTY_TO_LEVEL(PLAYER_GOOD, PRINCE2, -2,1)
	ADD_PARTY_TO_LEVEL(PLAYER_GOOD, PRINCE3, -3,1)
ENDIF


REM PL3,FLAG5 active music track
rem value 2: dk2track02.mp3
rem value 4: dk2track04.mp3
SET_MUSIC("dk2track02.mp3")
SET_FLAG(PLAYER3,FLAG5,2)

IF(PLAYER3,FLAG5 != 4)
    REM Time battle music been playing
    NEXT_COMMAND_REUSABLE
    SET_TIMER(PLAYER3,TIMER7)
ENDIF
IF(PLAYER0,ACTIVE_BATTLES == 0)
    REM Time battle has been going on
    NEXT_COMMAND_REUSABLE
    SET_TIMER(PLAYER3,TIMER6)
ENDIF
IF(PLAYER0,ACTIVE_BATTLES > 0)
    REM Time no battle has been going on
    NEXT_COMMAND_REUSABLE
    SET_TIMER(PLAYER3,TIMER5)
ENDIF

REM Start battle music if battle has been going on for at least 60 gameturns (3 seconds) and is not already playing
IF(PLAYER3,TIMER6 > 60)
    IF(PLAYER3,FLAG5 != 4)
        NEXT_COMMAND_REUSABLE
        SET_MUSIC("battle04.mp3")
        NEXT_COMMAND_REUSABLE
        SET_FLAG(PLAYER3,FLAG5,4)
    ENDIF
ENDIF

REM Start regular music if battle music lasted at least 15 seconds and no fighting has occured for at least 5 seconds
IF(PLAYER3,TIMER7 > 300)
    IF(PLAYER3,TIMER5 > 100)
        IF(PLAYER3,FLAG5 != 2)
            NEXT_COMMAND_REUSABLE
            SET_MUSIC("dk2track03.mp3")
            NEXT_COMMAND_REUSABLE
            SET_FLAG(PLAYER3,FLAG5,2)
        ENDIF
    ENDIF
ENDIF


IF(PLAYER_GOOD, KNIGHT == 1)
	DISPLAY_OBJECTIVE(177, PLAYER0)
ENDIF

IF(PLAYER_GOOD, KNIGHT == 2)
	DISPLAY_OBJECTIVE(178, PLAYER0)
ENDIF


SET_TIMER(PLAYER0,TIMER2)

IF(PLAYER0,TIMER2 >= 250)
   		IF(PLAYER0,IMP <= 4)
        		NEXT_COMMAND_REUSABLE
			ADD_CREATURE_TO_LEVEL(PLAYER0,IMP,PLAYER0,2,1,100)
        		NEXT_COMMAND_REUSABLE
        		SET_TIMER(PLAYER0,TIMER2)
		ENDIF
ENDIF 

IF_ACTION_POINT(3,PLAYER0)

	CHANGE_SLAB_TYPE(40,49,PRETTY_PATH)
	CHANGE_SLAB_TYPE(41,49,PRETTY_PATH)
	CHANGE_SLAB_TYPE(40,50,PRETTY_PATH)
	CHANGE_SLAB_TYPE(41,50,PRETTY_PATH)


ENDIF

IF_ACTION_POINT(4,PLAYER0)

	CHANGE_SLAB_TYPE(64,29,PRETTY_PATH)
	CHANGE_SLAB_TYPE(65,29,PRETTY_PATH)
	CHANGE_SLAB_TYPE(64,30,PRETTY_PATH)
	CHANGE_SLAB_TYPE(65,30,PRETTY_PATH)
	CHANGE_SLAB_TYPE(64,25,PRETTY_PATH)

ENDIF

IF_ACTION_POINT(5,PLAYER0)

	CHANGE_SLAB_TYPE(53,7,PRETTY_PATH)

ENDIF

IF_ACTION_POINT(6,PLAYER0)

	CHANGE_SLAB_TYPE(55,6,PRETTY_PATH)

ENDIF

IF_ACTION_POINT(7,PLAYER0)

	CHANGE_SLAB_TYPE(55,6,PRETTY_PATH)

ENDIF


IF_ACTION_POINT(1,PLAYER_GOOD)
	DISPLAY_OBJECTIVE(126, PLAYER0)
	LOSE_GAME
ENDIF

IF_ACTION_POINT(2,PLAYER_GOOD)
	DISPLAY_OBJECTIVE(126, PLAYER0)
	LOSE_GAME
ENDIF

IF_ACTION_POINT(8,PLAYER_GOOD)
	DISPLAY_OBJECTIVE(126, PLAYER0)
	LOSE_GAME
ENDIF

IF(PLAYER_GOOD, KNIGHT == 0)
	IF(PLAYER0, KNIGHT == 3)
			DISPLAY_OBJECTIVE(127, PLAYER0)
			WIN_GAME
	ENDIF
ENDIF

IF(PLAYER0, TIMER0 >= 2050)
	IF(PLAYER_GOOD, KNIGHT == 0)	
		IF(PLAYER0, KNIGHT <= 2)
			DISPLAY_OBJECTIVE(176, PLAYER0)
			LOSE_GAME
		ENDIF
	ENDIF
ENDIF

