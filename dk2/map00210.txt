REM ********************************************
REM
REM             Script for Level 210
REM
REM ********************************************
LEVEL_VERSION(1)
SET_GENERATE_SPEED(400)

MAX_CREATURES(PLAYER0, 15)
MAX_CREATURES(PLAYER1, 15)
MAX_CREATURES(PLAYER2, 15)
MAX_CREATURES(PLAYER3, 15)
MAX_CREATURES(PLAYER4, 6)

START_MONEY(PLAYER0, 4000)
START_MONEY(PLAYER1, 55000)
START_MONEY(PLAYER2, 55000)
START_MONEY(PLAYER3, 100000)
START_MONEY(PLAYER4, 55000)

COMPUTER_PLAYER(PLAYER1, 7)
COMPUTER_PLAYER(PLAYER2, 7)
COMPUTER_PLAYER(PLAYER3, 9)
COMPUTER_PLAYER(PLAYER4, 0)

ADD_CREATURE_TO_POOL(SORCEROR, 10)
ADD_CREATURE_TO_POOL(GOBLIN, 10)
ADD_CREATURE_TO_POOL(TROLL, 10)
ADD_CREATURE_TO_POOL(FIREFLY, 5)
ADD_CREATURE_TO_POOL(SALAMANDER, 10)
ADD_CREATURE_TO_POOL(DARK_MISTRESS, 10)
ADD_CREATURE_TO_POOL(BILE_DEMON, 10)
ADD_CREATURE_TO_POOL(DARK_ELF,20)

CREATURE_AVAILABLE(ALL_PLAYERS, SORCEROR, 1, 0)
CREATURE_AVAILABLE(ALL_PLAYERS, GOBLIN, 1, 0)
CREATURE_AVAILABLE(ALL_PLAYERS, FIREFLY, 1, 0)
CREATURE_AVAILABLE(ALL_PLAYERS, TROLL, 1, 0)
CREATURE_AVAILABLE(ALL_PLAYERS, SALAMANDER, 1, 0)
CREATURE_AVAILABLE(ALL_PLAYERS, DARK_MISTRESS, 1, 0)
CREATURE_AVAILABLE(ALL_PLAYERS, BILE_DEMON, 1, 0)
CREATURE_AVAILABLE(ALL_PLAYERS, DARK_ELF,1,0)

SET_GAME_RULE(TrainingRoomMaxLevel,4)

ROOM_AVAILABLE(ALL_PLAYERS, RESEARCH, 1, 1)
ROOM_AVAILABLE(ALL_PLAYERS, GARDEN, 1, 1)
ROOM_AVAILABLE(ALL_PLAYERS, LAIR, 1, 1)
ROOM_AVAILABLE(ALL_PLAYERS, TRAINING, 1, 1)
ROOM_AVAILABLE(ALL_PLAYERS, TREASURE, 1, 1)
ROOM_AVAILABLE(ALL_PLAYERS, WORKSHOP, 1, 1)
ROOM_AVAILABLE(ALL_PLAYERS, STONE_BRIDGE, 1, 1)

ROOM_AVAILABLE(ALL_PLAYERS, TORTURE, 1, 1)
ROOM_AVAILABLE(ALL_PLAYERS, GUARD_POST, 1, 1)
ROOM_AVAILABLE(ALL_PLAYERS, PRISON, 1, 1)

MAGIC_AVAILABLE(ALL_PLAYERS, POWER_HAND, 1, 1)
MAGIC_AVAILABLE(ALL_PLAYERS, POWER_OBEY, 1, 1)
MAGIC_AVAILABLE(ALL_PLAYERS, POWER_SLAP, 1, 1)
MAGIC_AVAILABLE(PLAYER0, POWER_IMP, 1, 1)
MAGIC_AVAILABLE(PLAYER1, POWER_IMP, 1, 1)
MAGIC_AVAILABLE(PLAYER2, POWER_IMP, 1, 1)
MAGIC_AVAILABLE(PLAYER3, POWER_IMP, 1, 1)
MAGIC_AVAILABLE(PLAYER4, POWER_IMP, 0, 0)
MAGIC_AVAILABLE(ALL_PLAYERS, POWER_LIGHTNING, 1, 0)
MAGIC_AVAILABLE(ALL_PLAYERS, POWER_HEAL_CREATURE, 1, 0)
MAGIC_AVAILABLE(ALL_PLAYERS, POWER_SIGHT, 1, 0)
MAGIC_AVAILABLE(ALL_PLAYERS, POWER_CALL_TO_ARMS, 1, 0)
MAGIC_AVAILABLE(ALL_PLAYERS, POWER_OBEY, 1, 0)
MAGIC_AVAILABLE(ALL_PLAYERS, POWER_DESTROY_WALLS, 1, 1)
MAGIC_AVAILABLE(ALL_PLAYERS, POWER_CAVE_IN, 1, 1)
MAGIC_AVAILABLE(ALL_PLAYERS, POWER_HOLD_AUDIENCE, 1, 0)

DOOR_AVAILABLE(ALL_PLAYERS, STEEL, 1, 0)
TRAP_AVAILABLE(ALL_PLAYERS, TURRET, 1, 0)
TRAP_AVAILABLE(ALL_PLAYERS, POISON_GAS, 1, 0)

ALLY_PLAYERS(PLAYER1,PLAYER2,3)
ALLY_PLAYERS(PLAYER2,PLAYER3,3)
ALLY_PLAYERS(PLAYER1,PLAYER3,3)
ALLY_PLAYERS(PLAYER1,PLAYER4,3)
ALLY_PLAYERS(PLAYER2,PLAYER4,3)
ALLY_PLAYERS(PLAYER3,PLAYER4,3)

IF(PLAYER1,DUNGEON_DESTROYED== 1)
  CHANGE_SLAB_TYPE(33,35,DIRT,MATCH)
ENDIF
IF(PLAYER2,DUNGEON_DESTROYED== 1)
  CHANGE_SLAB_TYPE(12,25,DIRT,MATCH)
ENDIF
IF(PLAYER3,DUNGEON_DESTROYED== 1)
  CHANGE_SLAB_TYPE(55,24,DIRT,MATCH)
ENDIF

IF(PLAYER4,DUNGEON_DESTROYED== 1)
  CHANGE_SLAB_TYPE(59,36,DIRT,MATCH)
ENDIF


REM this is because the ai won't dig any gold :(
SET_FLAG(PLAYER0,FLAG4,0)
IF(PLAYER3,DUNGEON_DESTROYED == 1)
  SET_FLAG(PLAYER0,FLAG4,1)
ENDIF

SET_TIMER(PLAYER4, TIMER0)
IF(PLAYER4, TIMER0 == 50)
	NEXT_COMMAND_REUSABLE
	ADD_OBJECT_TO_LEVEL(GOLD,1,100,PLAYER1)
ENDIF

IF(PLAYER4, TIMER0 >= 150)
  IF(PLAYER0,FLAG4 ==0)
	  NEXT_COMMAND_REUSABLE
	  SET_TIMER(PLAYER4, TIMER0)
  ENDIF
ENDIF

SET_GAME_RULE(ImpWorkExperience,124)
SET_HAND_RULE(PLAYER0,ANY_CREATURE,RULE1,DENY,DROPPED_TIME_LOWER,60)
SET_GAME_RULE(MaxThingsInHand,30)
REVEAL_MAP_LOCATION(PLAYER0,PLAYER0,-1)

CONCEAL_MAP_RECT(Player0, 127, 85, 510, 500,1)

if(player0,ENTRANCE == 9)
  next_command_reusable
  max_creatures(Player0,15)
ENDIF
if(player0,ENTRANCE == 18)
  next_command_reusable
  max_creatures(Player0,20)
ENDIF
if(player0,ENTRANCE == 27)
  next_command_reusable
  max_creatures(Player0,25)
ENDIF

if(player1,ENTRANCE == 9)
  next_command_reusable
  max_creatures(Player1,15)
ENDIF
if(player1,ENTRANCE == 18)
  next_command_reusable
  max_creatures(Player1,20)
ENDIF
if(player1,ENTRANCE == 27)
  next_command_reusable
  max_creatures(Player1,25)
ENDIF


if(player2,ENTRANCE == 9)
  next_command_reusable
  max_creatures(Player2,15)
ENDIF
if(player2,ENTRANCE == 18)
  next_command_reusable
  max_creatures(Player2,20)
ENDIF
if(player2,ENTRANCE == 27)
  next_command_reusable
  max_creatures(Player2,25)
ENDIF


if(player3,ENTRANCE == 9)
  next_command_reusable
  max_creatures(Player3,15)
ENDIF
if(player3,ENTRANCE == 18)
  next_command_reusable
  max_creatures(Player3,20)
ENDIF
if(player3,ENTRANCE == 27)
  next_command_reusable
  max_creatures(Player3,25)
ENDIF

if(player4,ENTRANCE == 9)
  next_command_reusable
  max_creatures(Player4,15)
ENDIF
if(player4,ENTRANCE == 18)
  next_command_reusable
  max_creatures(Player4,20)
ENDIF
if(player4,ENTRANCE == 27)
  next_command_reusable
  max_creatures(Player4,25)
ENDIF

SET_TIMER(PLAYER_GOOD,TIMER3)

IF(PLAYER_GOOD,TIMER3 >= 20)
  PLAY_MESSAGE(PLAYER0,SPEECH,"lvl11spe01.ogg")
  QUICK_OBJECTIVE(77,"You're not alone in your ambitions, Evil One. For joined you are by four unholy rivals, all who seek to rule this land. But none as true as you in wicked deed - so take them on, and sure you'll vanquish them and once they're gone your evilness will wholly triumph o'er foes both good and bad in this and other lands.")
ENDIF


IF(PLAYER_GOOD,TIMER3 >= 1000)
PLAY_MESSAGE(PLAYER0,SPEECH,"lvl11spe03.ogg")
QUICK_INFORMATION(78,"Beware, your rivals now unite as one in force to see you slain.")
ENDIF

IF_AVAILABLE(PLAYER0, BOULDER == 1)
  PLAY_MESSAGE(PLAYER0,SPEECH,"lvl11spe02.ogg")
  QUICK_INFORMATION(79,"The Boulder Trap. When creatures walk within its range, they will be crushed by an enormous rock which rumbles down upon them.")
ENDIF

REM PL3,FLAG5 active music track
rem value 2: dk2track02.mp3
rem value 4: dk2track04.mp3
SET_MUSIC("dk2track02.mp3")
SET_FLAG(PLAYER3,FLAG5,2)

IF(PLAYER3,FLAG5 != 4)
    REM Time battle music been playing
    NEXT_COMMAND_REUSABLE
    SET_TIMER(PLAYER3,TIMER7)
ENDIF
IF(PLAYER0,ACTIVE_BATTLES == 0)
    REM Time battle has been going on
    NEXT_COMMAND_REUSABLE
    SET_TIMER(PLAYER3,TIMER6)
ENDIF
IF(PLAYER0,ACTIVE_BATTLES > 0)
    REM Time no battle has been going on
    NEXT_COMMAND_REUSABLE
    SET_TIMER(PLAYER3,TIMER5)
ENDIF

REM Start battle music if battle has been going on for at least 60 gameturns (3 seconds) and is not already playing
IF(PLAYER3,TIMER6 > 60)
    IF(PLAYER3,FLAG5 != 4)
        NEXT_COMMAND_REUSABLE
        SET_MUSIC("battle03.mp3")
        NEXT_COMMAND_REUSABLE
        SET_FLAG(PLAYER3,FLAG5,4)
    ENDIF
ENDIF

REM Start regular music if battle music lasted at least 15 seconds and no fighting has occured for at least 5 seconds
IF(PLAYER3,TIMER7 > 300)
    IF(PLAYER3,TIMER5 > 100)
        IF(PLAYER3,FLAG5 != 2)
            NEXT_COMMAND_REUSABLE
            SET_MUSIC("dk2track02.mp3")
            NEXT_COMMAND_REUSABLE
            SET_FLAG(PLAYER3,FLAG5,2)
        ENDIF
    ENDIF
ENDIF

SET_TIMER(PLAYER0,TIMER2)

IF(PLAYER0,TIMER2 >= 250)
   		IF(PLAYER0,IMP <= 4)
        		NEXT_COMMAND_REUSABLE
			ADD_CREATURE_TO_LEVEL(PLAYER0,IMP,PLAYER0,2,1,100)
        		NEXT_COMMAND_REUSABLE
        		SET_TIMER(PLAYER0,TIMER2)
		ENDIF
ENDIF 

IF(PLAYER0, ALL_DUNGEONS_DESTROYED == 1)
  PLAY_MESSAGE(PLAYER0,SPEECH,"lvl11spe04.ogg")
  QUICK_OBJECTIVE(80,"Well done. The contest now is won. For all your rivals are defeated. Rest and celebrate!")
	WIN_GAME
ENDIF
