REM ********************************************
REM
REM             Script for Level 215
REM
REM ********************************************


LEVEL_VERSION(1)

SET_GENERATE_SPEED(400)

MAX_CREATURES(PLAYER0, 15)

START_MONEY(PLAYER0, 2500)

ADD_CREATURE_TO_POOL(SORCEROR, 10)
ADD_CREATURE_TO_POOL(GOBLIN, 10)
ADD_CREATURE_TO_POOL(TROLL, 10)
ADD_CREATURE_TO_POOL(FIREFLY, 5)
ADD_CREATURE_TO_POOL(SALAMANDER, 5)
ADD_CREATURE_TO_POOL(DARK_MISTRESS, 10)
ADD_CREATURE_TO_POOL(BILE_DEMON, 10)
ADD_CREATURE_TO_POOL(BLACK_KNIGHT, 10)
ADD_CREATURE_TO_POOL(DARK_ELF,20)

CREATURE_AVAILABLE(ALL_PLAYERS, SORCEROR, 1, 1)
CREATURE_AVAILABLE(ALL_PLAYERS, GOBLIN, 1, 1)
CREATURE_AVAILABLE(ALL_PLAYERS, FIREFLY, 1, 1)
CREATURE_AVAILABLE(ALL_PLAYERS, TROLL, 1, 1)
CREATURE_AVAILABLE(ALL_PLAYERS, DARK_MISTRESS, 1, 1)
CREATURE_AVAILABLE(ALL_PLAYERS, BILE_DEMON, 1, 1)
CREATURE_AVAILABLE(ALL_PLAYERS, SALAMANDER, 1, 1)
CREATURE_AVAILABLE(ALL_PLAYERS, BLACK_KNIGHT, 1, 0)
CREATURE_AVAILABLE(ALL_PLAYERS, DARK_ELF,1,0)

SET_GAME_RULE(TrainingRoomMaxLevel,4)

IF(PLAYER0, BARRACKS >= 8)
	SET_GAME_RULE(TrainingRoomMaxLevel,8)
ENDIF

ROOM_AVAILABLE(ALL_PLAYERS, RESEARCH, 1, 1)
ROOM_AVAILABLE(ALL_PLAYERS, GARDEN, 1, 1)
ROOM_AVAILABLE(ALL_PLAYERS, LAIR, 1, 1)
ROOM_AVAILABLE(ALL_PLAYERS, TRAINING, 3, 0)
ROOM_AVAILABLE(ALL_PLAYERS, TREASURE, 1, 1)
ROOM_AVAILABLE(ALL_PLAYERS, WORKSHOP, 3, 0)
ROOM_AVAILABLE(ALL_PLAYERS, STONE_BRIDGE, 1, 1)
ROOM_AVAILABLE(ALL_PLAYERS, TORTURE, 3, 0)
ROOM_AVAILABLE(ALL_PLAYERS, GUARD_POST, 3, 0)
ROOM_AVAILABLE(ALL_PLAYERS, PRISON, 3, 0)

MAGIC_AVAILABLE(ALL_PLAYERS, POWER_HAND, 1, 1)
MAGIC_AVAILABLE(ALL_PLAYERS, POWER_OBEY, 1, 1)
MAGIC_AVAILABLE(ALL_PLAYERS, POWER_SLAP, 1, 1)
MAGIC_AVAILABLE(ALL_PLAYERS, POWER_IMP, 1, 0)
MAGIC_AVAILABLE(ALL_PLAYERS, POWER_LIGHTNING, 1, 0)
MAGIC_AVAILABLE(ALL_PLAYERS, POWER_HEAL_CREATURE, 1, 0)
MAGIC_AVAILABLE(ALL_PLAYERS, POWER_SIGHT, 1, 0)
MAGIC_AVAILABLE(ALL_PLAYERS, POWER_CALL_TO_ARMS, 1, 0)
MAGIC_AVAILABLE(ALL_PLAYERS, POWER_OBEY, 1, 0)
MAGIC_AVAILABLE(ALL_PLAYERS, POWER_DESTROY_WALLS, 1, 1)
MAGIC_AVAILABLE(ALL_PLAYERS, POWER_CAVE_IN, 1, 1)
MAGIC_AVAILABLE(ALL_PLAYERS, POWER_HOLD_AUDIENCE, 1, 0)
MAGIC_AVAILABLE(ALL_PLAYERS, POWER_SPEED, 1, 0)
MAGIC_AVAILABLE(ALL_PLAYERS, POWER_DISEASE, 1, 0)
MAGIC_AVAILABLE(ALL_PLAYERS, POWER_CONCEAL, 1, 0)
MAGIC_AVAILABLE(ALL_PLAYERS, POWER_PROTECT, 1, 0)

DOOR_AVAILABLE(ALL_PLAYERS, WOOD, 1, 1)
DOOR_AVAILABLE(ALL_PLAYERS, SECRET, 1, 0)

SET_DOOR_CONFIGURATION(SECRET,ManufactureRequired,15000)

SET_GAME_RULE(ImpWorkExperience,124)

SET_GAME_RULE(MaxThingsInHand,30)
SET_HAND_RULE(PLAYER0,ANY_CREATURE,RULE1,DENY,DROPPED_TIME_LOWER,60)

CONCEAL_MAP_RECT(Player0, 127, 127, 250, 250,1)

if(player0,ENTRANCE == 9)
  next_command_reusable
  max_creatures(Player0,15)
ENDIF
if(player0,ENTRANCE == 18)
  next_command_reusable
  max_creatures(Player0,20)
ENDIF
if(player0,ENTRANCE == 27)
  next_command_reusable
  max_creatures(Player0,25)
ENDIF

REM INTRO

IF(PLAYER0,TIMER4 >= 20)
	PLAY_MESSAGE(PLAYER0,SPEECH,"lvl16spe01.ogg")
	QUICK_OBJECTIVE(100,"Beware, the King has now amassed an army great and large against you. Determined as he is to rid this realm of evil ever more. A vast Fortress houses this great legion. And your only hope lies in discovering its weakness. You must sneak amidst the darkened passages of Lord Pureheart's Castle, there to build your Dungeon dare, for he will ne'er suspect it.")
ENDIF

IF(PLAYER0, WORKSHOP >= 1)
	PLAY_MESSAGE(PLAYER0,SPEECH,"lvl16spe02.ogg")
	QUICK_OBJECTIVE(101,"With a dangerous exposed position, keep your presence hidden from the Heroes if you can. Use Secret Doors to hide your gradual advancement.")
ENDIF

IF_AVAILABLE(PLAYER0,SECRET == 1)
	PLAY_MESSAGE(PLAYER0,SPEECH,"lvl16spe03.ogg")
	QUICK_OBJECTIVE(102,"The Secret Door - remains concealed appearing just the same as those walls which surround it.")
ENDIF

SET_FLAG(PLAYER2,FLAG3,0)

IF_ACTION_POINT(1, PLAYER0)
    SET_FLAG(PLAYER2,FLAG3,1)
ENDIF

IF_ACTION_POINT(2, PLAYER0)
    SET_FLAG(PLAYER2,FLAG3,1)
ENDIF

IF_ACTION_POINT(3, PLAYER0)
    SET_FLAG(PLAYER2,FLAG3,1)
ENDIF

IF_ACTION_POINT(4, PLAYER0)
    SET_FLAG(PLAYER2,FLAG3,1)
ENDIF

IF(PLAYER2,FLAG3 == 1)
	PLAY_MESSAGE(PLAYER0,SPEECH,"lvl16spe04.ogg")
	QUICK_OBJECTIVE(92,"Beware now, Keeper, for the Heroes are alerted to your presence. Be assured that will try to hunt you down.")
ENDIF

RUN_AFTER_VICTORY(1)

CREATE_PARTY(HORNY)
    ADD_TO_PARTY(HORNY,EVILLORD,10,0,SNIPE_DUNGEON_HEART,-370)

COMPUTER_PLAYER(PLAYER6,ROAMING)
ALLY_PLAYERS(PLAYER0,PLAYER6,3)
ALLY_PLAYERS(PLAYER6,PLAYER_GOOD,3)
SET_PLAYER_COLOR(PLAYER6,RED)
SET_TIMER(PLAYER0,TIMER4)

IF(PLAYER0,TIMER4 >= 30)
    SET_POWER_CONFIGURATION(POWER_SIGHT,SoundPlayed,0)
    USE_POWER_AT_LOCATION(PLAYER0,5,POWER_SIGHT,6,1)
ENDIF

IF(PLAYER0,TIMER4 >= 40)
    ZOOM_TO_LOCATION(PLAYER0,5)
ENDIF
IF(PLAYER0,TIMER4 >= 50)
    ZOOM_TO_LOCATION(PLAYER0,5)
ENDIF
IF(PLAYER0,TIMER4 >= 60)
    ZOOM_TO_LOCATION(PLAYER0,5)
ENDIF
IF(PLAYER0,TIMER4 >= 70)
    ZOOM_TO_LOCATION(PLAYER0,5)
ENDIF
IF(PLAYER0,TIMER4 >= 80)
    ZOOM_TO_LOCATION(PLAYER0,5)
ENDIF
IF(PLAYER0,TIMER4 >= 90)
    ZOOM_TO_LOCATION(PLAYER0,5)
ENDIF
IF(PLAYER0,TIMER4 >= 100)
    ZOOM_TO_LOCATION(PLAYER0,5)
ENDIF
IF(PLAYER0,TIMER4 >= 110)
    ZOOM_TO_LOCATION(PLAYER0,5)
ENDIF
IF(PLAYER0,TIMER4 >= 120)
    ZOOM_TO_LOCATION(PLAYER0,5)
ENDIF
IF(PLAYER0,TIMER4 >= 130)
    ZOOM_TO_LOCATION(PLAYER0,5)
ENDIF
IF(PLAYER0,TIMER4 >= 140)
    ZOOM_TO_LOCATION(PLAYER0,5)
ENDIF
IF(PLAYER0,TIMER4 >= 150)
    ZOOM_TO_LOCATION(PLAYER0,5)
ENDIF
IF(PLAYER0,TIMER4 >= 160)
    ZOOM_TO_LOCATION(PLAYER0,5)
ENDIF
IF(PLAYER0,TIMER4 >= 170)
    ZOOM_TO_LOCATION(PLAYER0,5)
ENDIF
IF(PLAYER0,TIMER4 >= 180)
    ZOOM_TO_LOCATION(PLAYER0,5)
ENDIF
IF(PLAYER0,TIMER4 >= 190)
    ZOOM_TO_LOCATION(PLAYER0,5)
ENDIF

IF(PLAYER0,TIMER4 >= 200)
    ZOOM_TO_LOCATION(PLAYER0,PLAYER0)
    SET_POWER_CONFIGURATION(POWER_SIGHT,POWER,10,6)
    USE_POWER_AT_LOCATION(PLAYER0,5,POWER_SIGHT,6,1)
ENDIF

IF(PLAYER0,TIMER4 >= 210)
    SET_POWER_CONFIGURATION(POWER_SIGHT,SoundPlayed,51)
    SET_POWER_CONFIGURATION(POWER_SIGHT,POWER,896,6)
ENDIF

REM SETTINGS

CREATE_PARTY(P1B)
    ADD_TO_PARTY(P1B, WITCH, 3, 30, DEFEND_ROOMS,0)
    ADD_TO_PARTY(P1B, FAIRY, 2, 30, DEFEND_ROOMS,0)
    ADD_TO_PARTY(P1B, FAIRY, 3, 30, DEFEND_ROOMS,0)
    ADD_TO_PARTY(P1B, WITCH, 3, 30, DEFEND_ROOMS,0)
    ADD_TO_PARTY(P1B, WIZARD, 4, 30, DEFEND_ROOMS,0)
    ADD_TO_PARTY(P1B, MONK, 3, 30, DEFEND_ROOMS,0)

IF(PLAYER0,TIMER4 >= 300)
    ADD_PARTY_TO_LEVEL(PLAYER_GOOD,P1B,-1,1)
ENDIF

SET_TIMER(PLAYER4,TIMER0)

IF(PLAYER4,TIMER0 ==10)
    NEXT_COMMAND_REUSABLE
    CHANGE_SLAB_TYPE(50,47,PRETTY_PATH,MATCH)
        NEXT_COMMAND_REUSABLE
    CHANGE_SLAB_TYPE(26,47,GUARD_AREA,MATCH)
ENDIF

IF(PLAYER4,TIMER0 ==1010)
    NEXT_COMMAND_REUSABLE
    CHANGE_SLAB_TYPE(50,47,GUARD_AREA,MATCH)
        NEXT_COMMAND_REUSABLE
    CHANGE_SLAB_TYPE(26,47,PRETTY_PATH,MATCH)
ENDIF

IF(PLAYER4,TIMER0 >=2000)
    NEXT_COMMAND_REUSABLE
    SET_TIMER(PLAYER4,TIMER0)
ENDIF





















REM PL3,FLAG5 active music track
rem value 2: dk2track02.mp3
rem value 4: dk2track04.mp3
SET_MUSIC("dk2track03.mp3")
SET_FLAG(PLAYER3,FLAG5,2)

IF(PLAYER3,FLAG5 != 4)
    REM Time battle music been playing
    NEXT_COMMAND_REUSABLE
    SET_TIMER(PLAYER3,TIMER7)
ENDIF
IF(PLAYER0,ACTIVE_BATTLES == 0)
    REM Time battle has been going on
    NEXT_COMMAND_REUSABLE
    SET_TIMER(PLAYER3,TIMER6)
ENDIF
IF(PLAYER0,ACTIVE_BATTLES > 0)
    REM Time no battle has been going on
    NEXT_COMMAND_REUSABLE
    SET_TIMER(PLAYER3,TIMER5)
ENDIF

REM Start battle music if battle has been going on for at least 60 gameturns (3 seconds) and is not already playing
IF(PLAYER3,TIMER6 > 60)
    IF(PLAYER3,FLAG5 != 4)
        NEXT_COMMAND_REUSABLE
        SET_MUSIC("battle04.mp3")
        NEXT_COMMAND_REUSABLE
        SET_FLAG(PLAYER3,FLAG5,4)
    ENDIF
ENDIF

REM Start regular music if battle music lasted at least 15 seconds and no fighting has occured for at least 5 seconds
IF(PLAYER3,TIMER7 > 300)
    IF(PLAYER3,TIMER5 > 100)
        IF(PLAYER3,FLAG5 != 2)
            NEXT_COMMAND_REUSABLE
            SET_MUSIC("dk2track03.mp3")
            NEXT_COMMAND_REUSABLE
            SET_FLAG(PLAYER3,FLAG5,2)
        ENDIF
    ENDIF
ENDIF

SET_TIMER(PLAYER0,TIMER2)

IF(PLAYER0,TIMER2 >= 250)
   		IF(PLAYER0,IMP <= 4)
        		NEXT_COMMAND_REUSABLE
			ADD_CREATURE_TO_LEVEL(PLAYER0,IMP,PLAYER0,2,1,100)
        		NEXT_COMMAND_REUSABLE
        		SET_TIMER(PLAYER0,TIMER2)
		ENDIF
ENDIF 

IF(PLAYER_GOOD, KNIGHT == 0)
	PLAY_MESSAGE(PLAYER0,SPEECH,"lvl16spe05.ogg")
	QUICK_OBJECTIVE(93,"Thanks to your supremely evil ways, the Heroes now no longer sleep in their own beds without expecting trouble, even death. And when these goodly forces fear all times that death is near, then death will surely even sooner visit their domain.")
	WIN_GAME
	ALLY_PLAYERS(PLAYER0,PLAYER5,3)
	ADD_OBJECT_TO_LEVEL(FAKE_GEM,LAST_DEATH_EVENT[PLAYER_GOOD],1,PLAYER5)
 	COMPUTER_PLAYER(PLAYER5,0)
 	SET_TIMER(PLAYER6,TIMER6)
ENDIF

HIDE_HERO_GATE(1,1)
HIDE_HERO_GATE(2,1)

IF(PLAYER6,TIMER6 >= 20)
    MAGIC_AVAILABLE(PLAYER0,POWER_POSSESS,0,0)
ENDIF

IF(PLAYER6,TIMER6 >= 60)
        ADD_OBJECT_TO_LEVEL(HORNY_STATUE,-1,1,PLAYER0)
        ZOOM_TO_LOCATION(PLAYER0,-1)
        CREATE_EFFECT(EFFECT_FLASH,PLAYER0)
        CREATE_EFFECT(EFFECT_EXPLOSION_5,-1)
        CREATE_EFFECT(EFFECT_SPANGLE_RED,-1)
        CREATE_EFFECT(EFFECT_WORD_OF_POWER,-1)
ENDIF

IF(PLAYER6,TIMER6 >= 100)
        ADD_PARTY_TO_LEVEL(PLAYER6,HORNY,-1,1)
        SET_OBJECT_CONFIGURATION(HORNY_STATUE,MaximumSize,0)
ENDIF

IF(PLAYER5,HEART_HEALTH > 0)
    SET_FLAG(PLAYER0,FLAG0,8)
ENDIF
IF(PLAYER0,FLAG0 == 8)
    IF(PLAYER5,HEART_HEALTH < 3)
        SET_OBJECT_CONFIGURATION(FAKE_GEM,UpdateFunction,UPDATE_POWER_LIGHTNING)
        SET_TIMER(PLAYER6,TIMER7)
    ENDIF
    IF(PLAYER6,TIMER7 > 50)
        KILL_CREATURE(PLAYER6,EVILLORD,ANYWHERE,1)
    ENDIF
ENDIF