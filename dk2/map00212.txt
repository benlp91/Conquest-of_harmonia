REM ********************************************
REM
REM             Script for Level 212
REM
REM ********************************************
REM 

LEVEL_VERSION(1)

SET_GENERATE_SPEED(400)

MAX_CREATURES(PLAYER0, 15)
MAX_CREATURES(PLAYER1, 0)

START_MONEY(PLAYER0, 30000)
START_MONEY(PLAYER1, 500000)

COMPUTER_PLAYER(PLAYER1, 0)

ADD_CREATURE_TO_POOL(SORCEROR, 10)
ADD_CREATURE_TO_POOL(GOBLIN, 10)
ADD_CREATURE_TO_POOL(TROLL, 10)
ADD_CREATURE_TO_POOL(FIREFLY, 5)
ADD_CREATURE_TO_POOL(ORC, 10)
ADD_CREATURE_TO_POOL(DARK_MISTRESS, 10)
ADD_CREATURE_TO_POOL(BILE_DEMON, 10)
ADD_CREATURE_TO_POOL(DARK_ELF,20)

CREATURE_AVAILABLE(ALL_PLAYERS, SORCEROR, 1, 1)
CREATURE_AVAILABLE(ALL_PLAYERS, GOBLIN, 1, 1)
CREATURE_AVAILABLE(ALL_PLAYERS, FIREFLY, 1, 1)
CREATURE_AVAILABLE(ALL_PLAYERS, TROLL, 1, 1)
CREATURE_AVAILABLE(ALL_PLAYERS, DARK_MISTRESS, 1, 1)
CREATURE_AVAILABLE(ALL_PLAYERS, BILE_DEMON, 1, 1)
CREATURE_AVAILABLE(ALL_PLAYERS, DARK_ELF,1,0)

SET_GAME_RULE(TrainingRoomMaxLevel,4)

ROOM_AVAILABLE(ALL_PLAYERS, RESEARCH, 1, 1)
ROOM_AVAILABLE(ALL_PLAYERS, GARDEN, 1, 1)
ROOM_AVAILABLE(ALL_PLAYERS, LAIR, 1, 1)
ROOM_AVAILABLE(ALL_PLAYERS, TRAINING, 1, 1)
ROOM_AVAILABLE(ALL_PLAYERS, TREASURE, 1, 1)
ROOM_AVAILABLE(ALL_PLAYERS, WORKSHOP, 1, 1)
ROOM_AVAILABLE(ALL_PLAYERS, TORTURE, 1, 1)
ROOM_AVAILABLE(ALL_PLAYERS, GUARD_POST, 1, 1)
ROOM_AVAILABLE(ALL_PLAYERS, PRISON, 1, 1)
ROOM_AVAILABLE(ALL_PLAYERS, STONE_BRIDGE, 1, 1)

MAGIC_AVAILABLE(ALL_PLAYERS, POWER_HAND, 1, 1)
MAGIC_AVAILABLE(ALL_PLAYERS, POWER_OBEY, 1, 1)
MAGIC_AVAILABLE(ALL_PLAYERS, POWER_SLAP, 1, 1)
MAGIC_AVAILABLE(ALL_PLAYERS, POWER_IMP, 1, 1)
MAGIC_AVAILABLE(ALL_PLAYERS, POWER_LIGHTNING, 1, 0)
MAGIC_AVAILABLE(ALL_PLAYERS, POWER_HEAL_CREATURE, 1, 0)
MAGIC_AVAILABLE(ALL_PLAYERS, POWER_SIGHT, 1, 0)
MAGIC_AVAILABLE(ALL_PLAYERS, POWER_CALL_TO_ARMS, 1, 0)
MAGIC_AVAILABLE(ALL_PLAYERS, POWER_OBEY, 1, 0)
MAGIC_AVAILABLE(ALL_PLAYERS, POWER_CAVE_IN, 1, 1)
MAGIC_AVAILABLE(ALL_PLAYERS, POWER_HOLD_AUDIENCE, 1, 0)
MAGIC_AVAILABLE(ALL_PLAYERS, POWER_SPEED, 1, 0)
MAGIC_AVAILABLE(ALL_PLAYERS, POWER_DISEASE, 1, 0)
MAGIC_AVAILABLE(ALL_PLAYERS, POWER_DESTROY_WALLS, 1, 1)

DOOR_AVAILABLE(ALL_PLAYERS, STEEL, 1, 0)
TRAP_AVAILABLE(ALL_PLAYERS, TURRET, 1, 0)
TRAP_AVAILABLE(ALL_PLAYERS, POISON_GAS, 1, 0)

SET_GAME_RULE(ImpWorkExperience,124)

SET_GAME_RULE(MaxThingsInHand,30)
SET_HAND_RULE(PLAYER0,ANY_CREATURE,RULE1,DENY,DROPPED_TIME_LOWER,60)

REVEAL_MAP_LOCATION(PLAYER0,PLAYER0,-1)

CONCEAL_MAP_RECT(Player0, 160, 70, 455, 255,1)

IF(PLAYER1,DUNGEON_DESTROYED== 1)
  CHANGE_SLAB_TYPE(94,22,PATH,MATCH)
ENDIF

REVEAL_MAP_LOCATION(PLAYER0,8,2)
REVEAL_MAP_LOCATION(PLAYER0,5,2)
REVEAL_MAP_LOCATION(PLAYER0,4,6)

if(player0,ENTRANCE == 9)
  next_command_reusable
  max_creatures(Player0,15)
ENDIF
if(player0,ENTRANCE == 18)
  next_command_reusable
  max_creatures(Player0,20)
ENDIF
if(player0,ENTRANCE == 27)
  next_command_reusable
  max_creatures(Player0,25)
ENDIF

if(player1,ENTRANCE == 9)
  next_command_reusable
  max_creatures(Player1,15)
ENDIF
if(player1,ENTRANCE == 18)
  next_command_reusable
  max_creatures(Player1,20)
ENDIF
if(player1,ENTRANCE == 27)
  next_command_reusable
  max_creatures(Player1,25)
ENDIF

CREATE_PARTY(DOOR1)
ADD_TO_PARTY(DOOR1, MONK, 1, 300, ATTACK_DUNGEON_HEART, 0)
ADD_TO_PARTY(DOOR1, MONK, 1, 300, ATTACK_DUNGEON_HEART, 0)
ADD_TO_PARTY(DOOR1, BARBARIAN, 2, 300, ATTACK_DUNGEON_HEART, 0)
ADD_TO_PARTY(DOOR1, GIANT, 2, 300, ATTACK_DUNGEON_HEART, 0)

CREATE_PARTY(DOOR2)
ADD_TO_PARTY(DOOR2, BARBARIAN, 2, 300, ATTACK_DUNGEON_HEART, 0)
ADD_TO_PARTY(DOOR2, BARBARIAN, 3, 300, ATTACK_DUNGEON_HEART, 0)
ADD_TO_PARTY(DOOR2, BARBARIAN, 3, 300, ATTACK_DUNGEON_HEART, 0)
ADD_TO_PARTY(DOOR2, MONK, 3, 300, ATTACK_DUNGEON_HEART, 0)

CREATE_PARTY(DOOR3)
ADD_TO_PARTY(DOOR3, BARBARIAN, 4, 300, ATTACK_DUNGEON_HEART, 0)
ADD_TO_PARTY(DOOR3, GIANT, 4, 300, ATTACK_DUNGEON_HEART, 0)
ADD_TO_PARTY(DOOR3, WIZARD, 4, 300, ATTACK_DUNGEON_HEART, 0)
ADD_TO_PARTY(DOOR3, MONK, 4, 300, ATTACK_DUNGEON_HEART, 0)

REM INTRO

IF(PLAYER0,TIMER4 >= 20)
	PLAY_MESSAGE(PLAYER0,SPEECH,"lvl13spe01.ogg")
	QUICK_OBJECTIVE(81,"Behold the Monastery of Cuthbert the Thrice Martyred. See the pious Monks perform their holy customs, oh so peaceful seems! But somewhere lurking in the shadows hides the rival Keeper Maleus, poising ready to attack. He'll slay the Monks and turn them into Vampires, then he'll turn on you. But it's in your power to prevent this carnage, not that carnage is all bad, yet in this case such prevention maybe worth the prize - the Portal Gem which Maleus holds with undeserved pride.")
ENDIF

IF(PLAYER0,TIMER4 >= 2000)
	PLAY_MESSAGE(PLAYER0,SPEECH,"lvl13spe02.ogg")
	QUICK_OBJECTIVE(82,"Torture and convert these Monks, whose piety will prove short-lived. Once on your side their holy ways can be employed to rid you of your Vampire foes outright. For when they're slain by blessed hands they cannot rise again, as is their normal way.")
ENDIF

RUN_AFTER_VICTORY(1)

CREATE_PARTY(HORNY)
    ADD_TO_PARTY(HORNY,EVILLORD,10,0,SNIPE_DUNGEON_HEART,-370)

COMPUTER_PLAYER(PLAYER6,ROAMING)
ALLY_PLAYERS(PLAYER0,PLAYER6,3)
ALLY_PLAYERS(PLAYER6,PLAYER_GOOD,3)
SET_PLAYER_COLOR(PLAYER6,RED)
SET_TIMER(PLAYER0,TIMER4)

IF(PLAYER0,TIMER4 >= 30)
    SET_POWER_CONFIGURATION(POWER_SIGHT,SoundPlayed,0)
    USE_POWER_AT_LOCATION(PLAYER0,2,POWER_SIGHT,6,1)
ENDIF

IF(PLAYER0,TIMER4 >= 40)
    ZOOM_TO_LOCATION(PLAYER0,2)
ENDIF
IF(PLAYER0,TIMER4 >= 50)
    ZOOM_TO_LOCATION(PLAYER0,2)
ENDIF
IF(PLAYER0,TIMER4 >= 60)
    ZOOM_TO_LOCATION(PLAYER0,2)
ENDIF
IF(PLAYER0,TIMER4 >= 70)
    ZOOM_TO_LOCATION(PLAYER0,2)
ENDIF
IF(PLAYER0,TIMER4 >= 80)
    ZOOM_TO_LOCATION(PLAYER0,2)
ENDIF
IF(PLAYER0,TIMER4 >= 90)
    ZOOM_TO_LOCATION(PLAYER0,2)
ENDIF
IF(PLAYER0,TIMER4 >= 100)
    ZOOM_TO_LOCATION(PLAYER0,2)
ENDIF
IF(PLAYER0,TIMER4 >= 110)
    ZOOM_TO_LOCATION(PLAYER0,2)
ENDIF
IF(PLAYER0,TIMER4 >= 120)
    ZOOM_TO_LOCATION(PLAYER0,2)
ENDIF
IF(PLAYER0,TIMER4 >= 130)
    ZOOM_TO_LOCATION(PLAYER0,2)
ENDIF
IF(PLAYER0,TIMER4 >= 140)
    ZOOM_TO_LOCATION(PLAYER0,2)
ENDIF
IF(PLAYER0,TIMER4 >= 150)
    ZOOM_TO_LOCATION(PLAYER0,2)
ENDIF
IF(PLAYER0,TIMER4 >= 160)
    ZOOM_TO_LOCATION(PLAYER0,2)
ENDIF
IF(PLAYER0,TIMER4 >= 170)
    ZOOM_TO_LOCATION(PLAYER0,2)
ENDIF
IF(PLAYER0,TIMER4 >= 180)
    ZOOM_TO_LOCATION(PLAYER0,2)
ENDIF
IF(PLAYER0,TIMER4 >= 190)
    ZOOM_TO_LOCATION(PLAYER0,2)
ENDIF

IF(PLAYER0,TIMER4 >= 200)
    USE_POWER_AT_LOCATION(PLAYER0,PLAYER1,POWER_SIGHT,6,1)
    ZOOM_TO_LOCATION(PLAYER0,PLAYER1)
ENDIF
IF(PLAYER0,TIMER4 >= 210)
    ZOOM_TO_LOCATION(PLAYER0,PLAYER1)
ENDIF
IF(PLAYER0,TIMER4 >= 220)
    ZOOM_TO_LOCATION(PLAYER0,PLAYER1)
ENDIF
IF(PLAYER0,TIMER4 >= 230)
    ZOOM_TO_LOCATION(PLAYER0,PLAYER1)
ENDIF
IF(PLAYER0,TIMER4 >= 240)
    ZOOM_TO_LOCATION(PLAYER0,PLAYER1)
ENDIF
IF(PLAYER0,TIMER4 >= 250)
    ZOOM_TO_LOCATION(PLAYER0,PLAYER1)
ENDIF
IF(PLAYER0,TIMER4 >= 260)
    ZOOM_TO_LOCATION(PLAYER0,PLAYER1)
ENDIF
IF(PLAYER0,TIMER4 >= 270)
    ZOOM_TO_LOCATION(PLAYER0,PLAYER1)
ENDIF
IF(PLAYER0,TIMER4 >= 280)
    ZOOM_TO_LOCATION(PLAYER0,PLAYER1)
ENDIF
IF(PLAYER0,TIMER4 >= 290)
    ZOOM_TO_LOCATION(PLAYER0,PLAYER1)
ENDIF
IF(PLAYER0,TIMER4 >= 300)
    ZOOM_TO_LOCATION(PLAYER0,PLAYER1)
ENDIF
IF(PLAYER0,TIMER4 >= 310)
    ZOOM_TO_LOCATION(PLAYER0,PLAYER1)
ENDIF
IF(PLAYER0,TIMER4 >= 320)
    ZOOM_TO_LOCATION(PLAYER0,PLAYER1)
ENDIF

IF(PLAYER0,TIMER4 >= 330)
    ZOOM_TO_LOCATION(PLAYER0,PLAYER0)
    SET_POWER_CONFIGURATION(POWER_SIGHT,POWER,10,6)
    USE_POWER_AT_LOCATION(PLAYER0,PLAYER1,POWER_SIGHT,6,1)
ENDIF

IF(PLAYER0,TIMER4 >= 340)
    SET_POWER_CONFIGURATION(POWER_SIGHT,SoundPlayed,51)
    SET_POWER_CONFIGURATION(POWER_SIGHT,POWER,896,6)
ENDIF

REM SETTINGS

REM CHANGES FOR THE AI
CHANGE_CREATURES_ANNOYANCE(ALL_PLAYERS,VAMPIRE,SET,0)
SET_CREATURE_CONFIGURATION(VAMPIRE,Pay,100)

REM this is because the ai won't dig any gold :(

SET_TIMER(PLAYER4, TIMER0)
IF(PLAYER4, TIMER0 == 50)
	NEXT_COMMAND_REUSABLE
	ADD_OBJECT_TO_LEVEL(GOLD,3,100,PLAYER1)
ENDIF
IF(PLAYER4, TIMER0 >= 150)
	  NEXT_COMMAND_REUSABLE
	  SET_TIMER(PLAYER4, TIMER0)
ENDIF

SET_FLAG(PLAYER_GOOD,FLAG0,0)
SET_FLAG(PLAYER0,FLAG4,0)
SET_FLAG(PLAYER0,FLAG3,0)

IF(PLAYER_GOOD,FLAG0 == 0)
	IF(PLAYER0, ENTRANCE >= 1)
	PLAY_MESSAGE(PLAYER0,SPEECH,"lvl13spe03.ogg")
	QUICK_OBJECTIVE(85,"There is a secret known to Monks which tells of Vampires slain, whose method of destruction will deny them chance of life again. This knowledge is employed by them to overcome these fiends outright, and banish them forever from the land of living to eternal night.")
	SET_TIMER(PLAYER0,TIMER0)
		IF(PLAYER0,TIMER0 == 2700)
			NEXT_COMMAND_REUSABLE
			ADD_PARTY_TO_LEVEL(PLAYER_GOOD, DOOR1, -3, 1)
		ENDIF
	ENDIF
ENDIF

IF(PLAYER0,TIMER0 >= 5500)
	NEXT_COMMAND_REUSABLE
	SET_TIMER(PLAYER0,TIMER0)
ENDIF

IF(PLAYER0,FLAG3 == 0)
	IF(PLAYER0, ENTRANCE >= 1)
		IF(PLAYER0,TIMER0 == 5400)
			NEXT_COMMAND_REUSABLE
			ADD_PARTY_TO_LEVEL(PLAYER_GOOD, DOOR2, -4, 1)
		ENDIF
	ENDIF
ENDIF

IF_SLAB_OWNER(35,39,PLAYER0)
	IF_SLAB_OWNER(36,39,PLAYER0)
		IF_SLAB_OWNER(37,39,PLAYER0)
			IF_SLAB_OWNER(38,39,PLAYER0)
				IF_SLAB_OWNER(35,42,PLAYER0)
					IF_SLAB_OWNER(36,42,PLAYER0)
						IF_SLAB_OWNER(37,42,PLAYER0)
							IF_SLAB_OWNER(38,42,PLAYER0)
								IF_SLAB_OWNER(35,40,PLAYER0)
									IF_SLAB_OWNER(35,41,PLAYER0)
										IF_SLAB_OWNER(38,40,PLAYER0)
											IF_SLAB_OWNER(38,41,PLAYER0)
												SET_FLAG(PLAYER_GOOD,FLAG0,1)
												CHANGE_SLAB_TYPE(36,40,BROKEN_ENTRANCE2x2,MATCH)
												HIDE_HERO_GATE(-3,1)
				                				ZOOM_TO_LOCATION(PLAYER0,-3)
												PLAY_MESSAGE(PLAYER0,SPEECH,"lvl3spe08.ogg")
 												CREATE_EFFECT(EFFECT_HARMLESS_GAS_1,-3)
												USE_POWER_AT_LOCATION(PLAYER_GOOD,-3,POWER_CAVE_IN,6,1)
												CREATE_EFFECT(EFFECT_HARMLESS_GAS_1,7)
												USE_POWER_AT_LOCATION(PLAYER_GOOD,7,POWER_CAVE_IN,6,1)
												CREATE_EFFECT(EFFECT_HARMLESS_GAS_1,9)
												USE_POWER_AT_LOCATION(PLAYER_GOOD,9,POWER_CAVE_IN,6,1)
												PLAY_MESSAGE(PLAYER0,SOUND,152)
											ENDIF
										ENDIF
									ENDIF
								ENDIF
							ENDIF
						ENDIF
					ENDIF
				ENDIF
			ENDIF
		ENDIF
	ENDIF
ENDIF

IF_SLAB_OWNER(40,39,PLAYER0)
	IF_SLAB_OWNER(41,39,PLAYER0)
		IF_SLAB_OWNER(42,39,PLAYER0)
			IF_SLAB_OWNER(43,39,PLAYER0)
				IF_SLAB_OWNER(40,42,PLAYER0)
					IF_SLAB_OWNER(41,42,PLAYER0)
						IF_SLAB_OWNER(42,42,PLAYER0)
							IF_SLAB_OWNER(43,42,PLAYER0)
								IF_SLAB_OWNER(43,40,PLAYER0)
									IF_SLAB_OWNER(43,41,PLAYER0)
										IF_SLAB_OWNER(40,40,PLAYER0)
											IF_SLAB_OWNER(40,41,PLAYER0)
												SET_FLAG(PLAYER0,FLAG3,1)
												CHANGE_SLAB_TYPE(41,40,BROKEN_ENTRANCE2x2,MATCH)
												HIDE_HERO_GATE(-4,1)
				                				ZOOM_TO_LOCATION(PLAYER0,-4)
												PLAY_MESSAGE(PLAYER0,SPEECH,"lvl3spe08.ogg")
 												CREATE_EFFECT(EFFECT_HARMLESS_GAS_1,-4)
												USE_POWER_AT_LOCATION(PLAYER_GOOD,-4,POWER_CAVE_IN,6,1)
												CREATE_EFFECT(EFFECT_HARMLESS_GAS_1,10)
												USE_POWER_AT_LOCATION(PLAYER_GOOD,10,POWER_CAVE_IN,6,1)
												CREATE_EFFECT(EFFECT_HARMLESS_GAS_1,11)
												USE_POWER_AT_LOCATION(PLAYER_GOOD,11,POWER_CAVE_IN,6,1)
												PLAY_MESSAGE(PLAYER0,SOUND,152)
											ENDIF
										ENDIF
									ENDIF
								ENDIF
							ENDIF
						ENDIF
					ENDIF
				ENDIF
			ENDIF
		ENDIF
	ENDIF
ENDIF

REM only show

IF_SLAB_OWNER(10,7,PLAYER0)
	IF_SLAB_OWNER(11,7,PLAYER0)
		IF_SLAB_OWNER(12,7,PLAYER0)
			IF_SLAB_OWNER(13,7,PLAYER0)
				IF_SLAB_OWNER(10,10,PLAYER0)
					IF_SLAB_OWNER(11,10,PLAYER0)
						IF_SLAB_OWNER(12,10,PLAYER0)
							IF_SLAB_OWNER(13,10,PLAYER0)
								IF_SLAB_OWNER(10,8,PLAYER0)
									IF_SLAB_OWNER(10,9,PLAYER0)
										IF_SLAB_OWNER(13,8,PLAYER0)
											IF_SLAB_OWNER(13,9,PLAYER0)
												CHANGE_SLAB_TYPE(11,8,BROKEN_ENTRANCE2x2,MATCH)
												HIDE_HERO_GATE(-1,1)
												PLAY_MESSAGE(PLAYER0,SPEECH,"lvl3spe08.ogg")
												CREATE_EFFECT(EFFECT_HARMLESS_GAS_1,-1)
												USE_POWER_AT_LOCATION(PLAYER_GOOD,-1,POWER_CAVE_IN,6,1)
												CREATE_EFFECT(EFFECT_HARMLESS_GAS_1,13)
												USE_POWER_AT_LOCATION(PLAYER_GOOD,13,POWER_CAVE_IN,6,1)
												CREATE_EFFECT(EFFECT_HARMLESS_GAS_1,14)
												USE_POWER_AT_LOCATION(PLAYER_GOOD,14,POWER_CAVE_IN,6,1)
												PLAY_MESSAGE(PLAYER0,SOUND,152)
												ADD_PARTY_TO_LEVEL(PLAYER_GOOD, DOOR1, -1, 1)
											ENDIF
										ENDIF
									ENDIF
								ENDIF
							ENDIF
						ENDIF
					ENDIF
				ENDIF
			ENDIF
		ENDIF
	ENDIF
ENDIF

IF_SLAB_OWNER(19,7,PLAYER0)
	IF_SLAB_OWNER(20,7,PLAYER0)
		IF_SLAB_OWNER(21,7,PLAYER0)
			IF_SLAB_OWNER(22,7,PLAYER0)
				IF_SLAB_OWNER(19,10,PLAYER0)
					IF_SLAB_OWNER(20,10,PLAYER0)
						IF_SLAB_OWNER(21,10,PLAYER0)
							IF_SLAB_OWNER(22,10,PLAYER0)
								IF_SLAB_OWNER(19,8,PLAYER0)
									IF_SLAB_OWNER(19,9,PLAYER0)
										IF_SLAB_OWNER(22,8,PLAYER0)
											IF_SLAB_OWNER(22,9,PLAYER0)
												SET_FLAG(PLAYER0,FLAG3,1)
												CHANGE_SLAB_TYPE(21,40,BROKEN_ENTRANCE2x2,MATCH)
												HIDE_HERO_GATE(-2,1)
												PLAY_MESSAGE(PLAYER0,SPEECH,"lvl3spe08.ogg")
												CREATE_EFFECT(EFFECT_HARMLESS_GAS_1,-2)
												USE_POWER_AT_LOCATION(PLAYER_GOOD,-2,POWER_CAVE_IN,6,1)
												CREATE_EFFECT(EFFECT_HARMLESS_GAS_1,15)
												USE_POWER_AT_LOCATION(PLAYER_GOOD,15,POWER_CAVE_IN,6,1)
												CREATE_EFFECT(EFFECT_HARMLESS_GAS_1,16)
												USE_POWER_AT_LOCATION(PLAYER_GOOD,16,POWER_CAVE_IN,6,1)
												PLAY_MESSAGE(PLAYER0,SOUND,152)
												ADD_PARTY_TO_LEVEL(PLAYER_GOOD, DOOR1, -2, 1)
											ENDIF
										ENDIF
									ENDIF
								ENDIF
							ENDIF
						ENDIF
					ENDIF
				ENDIF
			ENDIF
		ENDIF
	ENDIF
ENDIF

SET_FLAG(PLAYER0,FLAG6, 0)

IF_ACTION_POINT(20, PLAYER0)
	SET_FLAG(PLAYER0,FLAG6, 1)
ENDIF

IF_ACTION_POINT(19, PLAYER0)
	SET_FLAG(PLAYER0,FLAG6, 1)
ENDIF

SET_TIMER(PLAYER4,TIMER4)

IF(PLAYER0,FLAG6 == 1)
		IF(PLAYER4,TIMER4 == 2400)
			NEXT_COMMAND_REUSABLE
			ADD_PARTY_TO_LEVEL(PLAYER_GOOD, DOOR3, -5, 1)
		ENDIF
ENDIF

IF(PLAYER4,TIMER4 >= 2500)
	NEXT_COMMAND_REUSABLE
	SET_TIMER(PLAYER4,TIMER4)
ENDIF

IF_SLAB_OWNER(49,9,PLAYER0)
	IF_SLAB_OWNER(50,9,PLAYER0)
		IF_SLAB_OWNER(51,9,PLAYER0)
			IF_SLAB_OWNER(52,9,PLAYER0)
				IF_SLAB_OWNER(49,12,PLAYER0)
					IF_SLAB_OWNER(50,12,PLAYER0)
						IF_SLAB_OWNER(51,12,PLAYER0)
							IF_SLAB_OWNER(52,12,PLAYER0)
								IF_SLAB_OWNER(49,10,PLAYER0)
									IF_SLAB_OWNER(49,11,PLAYER0)
										IF_SLAB_OWNER(52,10,PLAYER0)
											IF_SLAB_OWNER(52,11,PLAYER0)
												SET_FLAG(PLAYER0,FLAG6,2)
												CHANGE_SLAB_TYPE(46,20,BROKEN_ENTRANCE2x2,MATCH)
												HIDE_HERO_GATE(-5,1)
				                				ZOOM_TO_LOCATION(PLAYER0,-5)
												PLAY_MESSAGE(PLAYER0,SPEECH,"lvl3spe08.ogg")
 												CREATE_EFFECT(EFFECT_HARMLESS_GAS_1,-5)
												USE_POWER_AT_LOCATION(PLAYER_GOOD,-5,POWER_CAVE_IN,6,1)
												CREATE_EFFECT(EFFECT_HARMLESS_GAS_1,17)
												USE_POWER_AT_LOCATION(PLAYER_GOOD,17,POWER_CAVE_IN,6,1)
												CREATE_EFFECT(EFFECT_HARMLESS_GAS_1,18)
												USE_POWER_AT_LOCATION(PLAYER_GOOD,18,POWER_CAVE_IN,6,1)
												PLAY_MESSAGE(PLAYER0,SOUND,152)
											ENDIF
										ENDIF
									ENDIF
								ENDIF
							ENDIF
						ENDIF
					ENDIF
				ENDIF
			ENDIF
		ENDIF
	ENDIF
ENDIF

REM TRIGGER FOR ASSAULT

IF_ACTION_POINT(2, PLAYER0)
	SET_FLAG(PLAYER0,FLAG4, 1)
ENDIF

IF_SLAB_TYPE(79,13,PATH)
	SET_FLAG(PLAYER1,FLAG4, 1)
ENDIF

IF_SLAB_TYPE(87,24,PATH)
	SET_FLAG(PLAYER1,FLAG4, 1)
ENDIF

IF_SLAB_TYPE(80,35,PATH)
	SET_FLAG(PLAYER1,FLAG4, 1)
ENDIF

IF(PLAYER1,FLAG4 == 1)
  IF(PLAYER0,FLAG4 == 1)
  	SET_TIMER(PLAYER0, TIMER1)
  ENDIF
ENDIF

IF(PLAYER0, TIMER1 >= 100)
  PLAY_MESSAGE(PLAYER0,SPEECH,"lvl13spe04.ogg")
  QUICK_OBJECTIVE(84,"Here's the realm of Maleus. Look alert, he sends his Vampires out to crush you first, I hope you are prepared.")
	IF(PLAYER0, TIMER1 >= 350)
		CHANGE_SLAB_TYPE(88,24,PATH)
		CHANGE_SLAB_TYPE(87,24,PATH)
		CHANGE_SLAB_TYPE(82,36,PATH)
		CHANGE_SLAB_TYPE(82,35,PATH)
		CHANGE_SLAB_TYPE(81,35,PATH)
		CHANGE_SLAB_TYPE(80,35,PATH)
     	CHANGE_SLAB_TYPE(80,11,PATH)
     	CHANGE_SLAB_TYPE(80,12,PATH)
		CHANGE_SLAB_TYPE(79,12,PATH)
		CHANGE_SLAB_TYPE(79,13,PATH)
      	USE_POWER_AT_LOCATION(PLAYER1,PLAYER1,POWER_CALL_TO_ARMS,9,1)
		SET_TIMER(PLAYER3, TIMER1)
	ENDIF
ENDIF

IF(PLAYER3,TIMER1 == 10)
	NEXT_COMMAND_REUSABLE
      	USE_POWER_AT_LOCATION(PLAYER1,PLAYER1,POWER_CALL_TO_ARMS,9,1)
ENDIF

IF(PLAYER3,TIMER1 == 25)
	NEXT_COMMAND_REUSABLE
      	USE_POWER_AT_LOCATION(PLAYER1,2,POWER_CALL_TO_ARMS,9,1)
ENDIF

IF(PLAYER3,TIMER1 == 40)
	NEXT_COMMAND_REUSABLE
      	USE_POWER_AT_LOCATION(PLAYER1,19,POWER_CALL_TO_ARMS,9,1)
ENDIF

IF(PLAYER3,TIMER1 == 50)
	NEXT_COMMAND_REUSABLE
      	USE_POWER_AT_LOCATION(PLAYER1,PLAYER0,POWER_CALL_TO_ARMS,9,1)
ENDIF

IF(PLAYER3,TIMER1 >= 1000)
	NEXT_COMMAND_REUSABLE
   	SET_TIMER(PLAYER3, TIMER1)
ENDIF

REM PL3,FLAG5 active music track
rem value 2: dk2track02.mp3
rem value 4: dk2track04.mp3
SET_MUSIC("dk2track01.mp3")
SET_FLAG(PLAYER3,FLAG5,2)

IF(PLAYER3,FLAG5 != 4)
    REM Time battle music been playing
    NEXT_COMMAND_REUSABLE
    SET_TIMER(PLAYER3,TIMER7)
ENDIF
IF(PLAYER0,ACTIVE_BATTLES == 0)
    REM Time battle has been going on
    NEXT_COMMAND_REUSABLE
    SET_TIMER(PLAYER3,TIMER6)
ENDIF
IF(PLAYER0,ACTIVE_BATTLES > 0)
    REM Time no battle has been going on
    NEXT_COMMAND_REUSABLE
    SET_TIMER(PLAYER3,TIMER5)
ENDIF

REM Start battle music if battle has been going on for at least 60 gameturns (3 seconds) and is not already playing
IF(PLAYER3,TIMER6 > 60)
    IF(PLAYER3,FLAG5 != 4)
        NEXT_COMMAND_REUSABLE
        SET_MUSIC("battle02.mp3")
        NEXT_COMMAND_REUSABLE
        SET_FLAG(PLAYER3,FLAG5,4)
    ENDIF
ENDIF

REM Start regular music if battle music lasted at least 15 seconds and no fighting has occured for at least 5 seconds
IF(PLAYER3,TIMER7 > 300)
    IF(PLAYER3,TIMER5 > 100)
        IF(PLAYER3,FLAG5 != 2)
            NEXT_COMMAND_REUSABLE
            SET_MUSIC("dk2track01.mp3")
            NEXT_COMMAND_REUSABLE
            SET_FLAG(PLAYER3,FLAG5,2)
        ENDIF
    ENDIF
ENDIF

SET_TIMER(PLAYER0,TIMER2)

IF(PLAYER0,TIMER2 >= 250)
   		IF(PLAYER0,IMP <= 4)
        		NEXT_COMMAND_REUSABLE
			ADD_CREATURE_TO_LEVEL(PLAYER0,IMP,PLAYER0,2,1,100)
        		NEXT_COMMAND_REUSABLE
        		SET_TIMER(PLAYER0,TIMER2)
		ENDIF
ENDIF 

IF(PLAYER0, ALL_DUNGEONS_DESTROYED == 1)
	PLAY_MESSAGE(PLAYER0,SPEECH,"lvl13spe05.ogg")
	QUICK_OBJECTIVE(86,"I am impressed. Your evil now begins to match my own, at last - an almost worthy comrade.")
	WIN_GAME
	ALLY_PLAYERS(PLAYER0,PLAYER5,3)
	ADD_OBJECT_TO_LEVEL(FAKE_GEM,12,1,PLAYER5)
 	COMPUTER_PLAYER(PLAYER5,0)
 	SET_TIMER(PLAYER6,TIMER6)
ENDIF

HIDE_HERO_GATE(8,1)

IF(PLAYER6,TIMER6 >= 20)
    MAGIC_AVAILABLE(PLAYER0,POWER_POSSESS,0,0)
ENDIF

IF(PLAYER6,TIMER6 >= 60)
        ADD_OBJECT_TO_LEVEL(HORNY_STATUE,-8,1,PLAYER0)
        ZOOM_TO_LOCATION(PLAYER0,-8)
        CREATE_EFFECT(EFFECT_FLASH,PLAYER0)
        CREATE_EFFECT(EFFECT_EXPLOSION_5,-8)
        CREATE_EFFECT(EFFECT_SPANGLE_RED,-8)
        CREATE_EFFECT(EFFECT_WORD_OF_POWER,-8)
ENDIF

IF(PLAYER6,TIMER6 >= 100)
        ADD_PARTY_TO_LEVEL(PLAYER6,HORNY,-8,1)
        SET_OBJECT_CONFIGURATION(HORNY_STATUE,MaximumSize,0)
ENDIF

IF(PLAYER5,HEART_HEALTH > 0)
    SET_FLAG(PLAYER0,FLAG0,8)
ENDIF
IF(PLAYER0,FLAG0 == 8)
    IF(PLAYER5,HEART_HEALTH < 3)
        SET_OBJECT_CONFIGURATION(FAKE_GEM,UpdateFunction,UPDATE_POWER_LIGHTNING)
        SET_TIMER(PLAYER6,TIMER7)
    ENDIF
    IF(PLAYER6,TIMER7 > 50)
        KILL_CREATURE(PLAYER6,EVILLORD,ANYWHERE,1)
    ENDIF
ENDIF
